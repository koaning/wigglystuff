var P=Object.defineProperty;var R=(n,e,t)=>e in n?P(n,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):n[e]=t;var c=(n,e,t)=>R(n,typeof e!="symbol"?e+"":e,t);var p;import{d as b,i as W,n as h}from"./jotai-D74Ef_p1.js";import{Ft as L,It as z,Lt as B,Nr as K,Nt as j,Or as Q,Pt as X,Qt as D,Rt as Y,St as J,V as Z,Xt as ee,Yt as te,nn as w,on as ne,or as v,rn as ie,sr as k,tn as o}from"./cells-B1ds6ZjK.js";import{x as re}from"./_Uint8Array-BGESiCQL.js";import{i as se}from"./useLifecycle-bYJVBwo9.js";import{t as ae}from"./debounce-BzCP2SOK.js";import{u as a}from"./hotkeys-sK-kaEBC.js";import{t as x}from"./invariant-EWlZS5z8.js";import{d as oe,g as S}from"./utils-Clm_pCuX.js";import{r as le}from"./config-BwUC_LRl.js";import{St as m,Ut as E,at as ce,ct as M}from"./dist-hQAzR0Cy.js";import{C as ue,D as T,E as F,h as de}from"./dist-BWV-5FQQ.js";import{n as g}from"./once-DF3Ybce_.js";import{t as me}from"./requests-CMMs4cl8.js";import{t as pe}from"./use-toast-CTk3v2Fk.js";import{a as he}from"./connection-DZfQ0nfK.js";var ge="Expected a function";function fe(n,e,t){var r=!0,s=!0;if(typeof n!="function")throw TypeError(ge);return re(t)&&(r="leading"in t?!!t.leading:r,s="trailing"in t?!!t.trailing:s),ae(n,e,{leading:r,maxWait:e,trailing:s})}var we=fe;function ve(n){"scheduler"in window?window.scheduler.postTask(n,{priority:"background"}):"requestIdleCallback"in window?requestIdleCallback(n):setTimeout(n,0)}var y=null,ye=class{constructor(n){c(this,"abortController",new AbortController);this.view=n.view,this.view.dom.addEventListener("focus",()=>{y=new WeakRef(this.view)},{signal:this.abortController.signal,capture:!0}),this.update()}update(){let n=this.view.dom.querySelector(".cm-vimCursorLayer");if(n instanceof HTMLElement)if(Z())n.style.display="none";else{let e=(y==null?void 0:y.deref())===this.view;n.style.display=e?"":"none"}}destroy(){this.abortController.abort()}};const N={map:{args:["lhs","rhs"]},nmap:{mode:"normal",args:["lhs","rhs"]},vmap:{mode:"visual",args:["lhs","rhs"]},imap:{mode:"insert",args:["lhs","rhs"]},noremap:{args:["lhs","rhs"]},nnoremap:{mode:"normal",args:["lhs","rhs"]},vnoremap:{mode:"visual",args:["lhs","rhs"]},inoremap:{mode:"insert",args:["lhs","rhs"]},unmap:{args:["lhs"]},nunmap:{mode:"normal",args:["lhs"]},vunmap:{mode:"visual",args:["lhs"]},iunmap:{mode:"insert",args:["lhs"]},mapclear:{},nmapclear:{mode:"normal"},vmapclear:{mode:"visual"},imapclear:{mode:"insert"}};function Ce(n,e){let t=[];for(let r of n.split(`
`)){if(r.startsWith('"')||r.trim()==="")continue;let s=be(r,e);s&&t.push(s)}return t}function be(n,e){let t=n.split(/\s+/),r=t[0],s=0;if(r in N){let i=N[r],u={};for(let f of i.args||[])if(s+=1,s<t.length)u[f]=t[s];else{e&&e(`Not enough arguments for "${r}" command: "${n}"`);return}let d={name:r};return"args"in i&&(d.args=u),"mode"in i&&(d.mode=i.mode),d}e&&e(`Unknown vimrc command: "${n}"`)}function xe(){return Ie(),De(),[m.of([{key:"j",run:n=>{if(te(n,!0)&&D(n)){let e=n.state.facet(v),t=n.state.facet(k);return e.moveToNextCell({cellId:t,before:!1,noCreate:!0}),!0}return!1}}]),m.of([{key:"k",run:n=>{if(ee(n)&&D(n)){let e=n.state.facet(v),t=n.state.facet(k);return e.moveToNextCell({cellId:t,before:!0,noCreate:!0}),!0}return!1}}]),m.of([{linux:"Ctrl-[",win:"Ctrl-[",run:n=>{let e=w(n);return e?$(e)?e.state.vim.insertMode?(o.exitInsertMode(e,!0),!0):!1:(a.warn("Expected CodeMirror instance to have Vim state"),!1):(a.warn("Expected CodeMirror instance to have CodeMirror instance state"),!1)}}]),M.define(n=>(requestAnimationFrame(()=>{O.INSTANCES.addInstance(n)}),{destroy(){O.INSTANCES.removeInstance(n)}})),M.define(n=>new ye({view:n})),ce.domEventHandlers({keydown(n,e){return n.ctrlKey&&n.key==="Escape"?(e.dom.dispatchEvent(new KeyboardEvent(n.type,n)),!0):!1}})]}var Ie=g(()=>{o.defineAction("goToDefinition",n=>{let e=n.cm6;return ne(e)}),o.mapCommand("gd","action","goToDefinition",{},{context:"normal"}),o.defineEx("write","w",n=>{let e=n.cm6;e&&e.state.facet(v).saveNotebook()})}),De=g(async()=>{var e;let n=(e=h.get(S).keymap)==null?void 0:e.vimrc;if(n)try{a.log(`Loading vimrc from ${n}`);let t=(await me().sendFileDetails({path:n})).contents;if(!t){a.error(`Failed to load vimrc from ${n}`);return}ke(Ce(t,a.warn))}catch(t){a.error("Failed to load vimrc:",t)}});function ke(n){function e(i){if(!i.args){a.warn(`Could not execute vimrc command "${i.name}: expected arguments"`);return}if(!i.args.lhs||!i.args.rhs){a.warn(`Could not execute vimrc command "${i.name}: expected arguments"`);return}i.mode?o.map(i.args.lhs,i.args.rhs,i.mode):o.map(i.args.lhs,i.args.rhs)}function t(i){if(!i.args){a.warn(`Could not execute vimrc command "${i.name}: expected arguments"`);return}if(!i.args.lhs||!i.args.rhs){a.warn(`Could not execute vimrc command "${i.name}: expected arguments"`);return}i.mode?o.noremap(i.args.lhs,i.args.rhs,i.mode):o.noremap(i.args.lhs,i.args.rhs)}function r(i){if(!i.args){a.warn(`Could not execute vimrc command "${i.name}: expected arguments"`);return}if(!i.args.lhs){a.warn(`Could not execute vimrc command "${i.name}: expected arguments"`);return}i.mode?o.unmap(i.args.lhs,i.mode):o.unmap(i.args.lhs)}function s(i){i.mode?o.mapclear(i.mode):o.mapclear()}for(let i of n)"map|nmap|vmap|imap".split("|").includes(i.name)?e(i):"noremap|nnoremap|vnoremap|inoremap".split("|").includes(i.name)?t(i):"unmap|nunmap|vunmap|iunmap".split("|").includes(i.name)?r(i):"mapclear|nmapclear|vmapclear|imapclear".split("|").includes(i.name)?s(i):a.warn(`Could not execute vimrc command "${i.name}: unknown command"`)}var O=(p=class{constructor(){c(this,"instances",new Set);c(this,"isBroadcasting",!1)}addInstance(e){this.instances.add(e);let t=w(e);if(!t){a.warn("Expected CodeMirror instance to have CodeMirror instance state");return}t.on("vim-mode-change",r=>{this.isBroadcasting||(x("mode"in r,'Expected event to have a "mode" property'),this.isBroadcasting=!0,ve(()=>{this.broadcastModeChange(e,r.mode,r.subMode),this.isBroadcasting=!1}))})}removeInstance(e){this.instances.delete(e)}broadcastModeChange(e,t,r){x("exitInsertMode"in o,"Vim does not have an exitInsertMode method"),x("exitVisualMode"in o,"Vim does not have an exitVisualMode method");for(let s of this.instances)if(s!==e){let i=w(s);if(!i){a.warn("Expected CodeMirror instance to have CodeMirror instance state");continue}let u=i.setSelections.bind(i);if(i.setSelections=()=>[],!$(i)){a.warn("Expected CodeMirror instance to have Vim state");continue}let d=i.state.vim;switch(t){case"normal":d.insertMode&&o.exitInsertMode(i,!0),d.visualMode&&o.exitVisualMode(i,!0);break;case"insert":d.insertMode||o.handleKey(i,"i","");break;case"visual":break}i.setSelections=u}}},c(p,"INSTANCES",new p),p);function $(n){return n.state.vim!==void 0}const Se=["default","vim"];function Ee(n,e){switch(n.preset){case"default":return[m.of(H()),m.of(V(e))];case"vim":return[m.of(Te()),m.of(V(e)),m.of([{key:"Enter",run:t=>{var r,s;return(s=(r=w(t))==null?void 0:r.state.vim)!=null&&s.insertMode?ue(t):!1}}]),E.high(Fe("d",t=>t.state.doc.toString()==="",t=>t.state.doc.toString()===""?(t.state.facet(v).deleteCell(),!0):!1)),ie({status:!1}),E.high(xe())];default:return se(n.preset),[]}}var Me=new Set([T,F]),H=g(()=>de.filter(n=>!Me.has(n.run))),V=n=>[{key:n.getHotkey("cell.toggleComment").key,run:T},{key:n.getHotkey("cell.toggleBlockComment").key,run:F}],Te=g(()=>{let n=new Set(["Enter","Ctrl-v"]);return H().filter(e=>!n.has(e.key||e.mac||e.linux||e.win||""))});function Fe(n,e,t){let r="",s=0;return m.of([{any:(i,u)=>{let d=u.key,f=u.timeStamp;return d!==n||!e(i)?(r="",s=0,!1):r===n&&f-s<500&&t(i)?(r="",s=0,!0):(r=d,s=f,!1)}}])}var q="marimo:copilot:signedIn";const Ne=K(q,null,J,{getOnInit:!0}),Oe=b(null),C=b(null),I=b({busy:!1,kind:null,message:null});function $e(n){h.set(C,n)}function He(n){h.get(C)===n&&h.set(C,null)}function Ve(){return Q.getItem(q)==="true"}function _(){let n=Ve(),e=oe();return n&&e.completion.copilot==="github"}function qe(){return W(S,n=>n.completion.copilot==="github")}var _e=z(),l=a.get("@github/copilot-language-server"),Ge=class extends L{constructor(...e){super(...e);c(this,"documentVersion",0);c(this,"hasOpenedDocument",!1);c(this,"getCompletionInternal",async(e,t)=>await this._request("textDocument/inlineCompletion",{...e,textDocument:{...e.textDocument,version:t}}));c(this,"throttledGetCompletionInternal",we(this.getCompletionInternal,200));c(this,"handleNotification",e=>{if(!e.params)return;let t=e;if(t.method==="statusNotification"&&h.set(I,t.params),t.method==="didChangeStatus"&&h.set(I,t.params),t.method==="window/logMessage"){let{type:r,message:s}=t.params;switch(r){case 1:l.error("[GitHub Copilot]",s);break;case 2:l.warn("[GitHub Copilot]",s);break;case 3:l.debug("[GitHub Copilot]",s);break;default:l.log("[GitHub Copilot]",s);break}}});this.onNotification(this.handleNotification)}async _request(e,t){return await this.request(e,t)}async notify(e,t){return l.debug("#notify",e,t),super.notify(e,t)}getInitializationOptions(){let e={name:"marimo",version:"0.1.0"};return{...super.getInitializationOptions(),workspaceFolders:[],capabilities:{workspace:{workspaceFolders:!1}},initializationOptions:{editorInfo:e,editorPluginInfo:e}}}isDisabled(){return!_()}async textDocumentDidOpen(e){return this.isDisabled()?e:(this.hasOpenedDocument=!0,super.textDocumentDidOpen(e))}async textDocumentCompletion(e){return[]}async textDocumentDidChange(e){if(this.isDisabled())return e;this.hasOpenedDocument||await this.textDocumentDidOpen({textDocument:{uri:e.textDocument.uri,languageId:"python",version:e.textDocument.version,text:e.contentChanges[0].text}});let t=e.contentChanges;t.length!==1&&l.warn("#textDocumentDidChange: Multiple changes detected. This is not supported.",t);let r=t[0];"range"in r&&l.warn("#textDocumentDidChange: Copilot doesn't support range changes.",r);let s=j(r.text);return super.textDocumentDidChange({...e,contentChanges:[{text:s}],textDocument:_e.VersionedTextDocumentIdentifier.create(e.textDocument.uri,++this.documentVersion)})}textDocumentHover(e){return Promise.resolve({contents:[]})}signOut(){return this._request("signOut",{})}async signInInitiate(){l.log("#signInInitiate: Starting sign-in flow");try{let e=await this._request("signIn",{});return l.log("#signInInitiate: Sign-in flow started successfully"),e}catch(e){throw l.warn("#signInInitiate: Failed to start sign-in flow",e),e}}async signInConfirm(e){l.log("#signInConfirm: Confirming sign-in");try{let t=await this._request("signInConfirm",e);return l.log("#signInConfirm: Sign-in confirmed successfully"),t}catch(t){throw l.warn("#signInConfirm: Failed to confirm sign-in",t),t}}async signedIn(){try{let{status:e}=await this._request("checkStatus",{});return l.log("#checkStatus: Status check completed",{status:e}),e==="SignedIn"||e==="AlreadySignedIn"||e==="OK"}catch(e){throw l.warn("#signedIn: Failed to check sign-in status",e),e}}async getCompletion(e){if(this.isDisabled())return null;let t=this.documentVersion;if(e.textDocument.version=t,t===0)return null;$e(t);let r=await this.throttledGetCompletionInternal(e,t);return He(t),t===this.documentVersion?r??null:null}},Ue=B(),Ae=Y(),Pe=class extends Ae.Transport{constructor(e){super();c(this,"pendingSubscriptions",[]);this.delegate=void 0,this.pendingSubscriptions=[],this.options={retries:e.retries??3,retryDelayMs:e.retryDelayMs??1e3,maxTimeoutMs:e.maxTimeoutMs??5e3,getWsUrl:e.getWsUrl,waitForReady:e.waitForReady,showError:e.showError}}subscribe(...e){super.subscribe(...e);let[t,r]=e;this.pendingSubscriptions.push({event:t,handler:r}),this.delegate&&this.delegate.subscribe(t,r)}unsubscribe(...e){let t=super.unsubscribe(...e),[r,s]=e;if(this.delegate&&this.delegate.unsubscribe(r,s),s)if(r){let i=this.pendingSubscriptions.findIndex(u=>u.event===r&&u.handler===s);i>-1&&this.pendingSubscriptions.splice(i,1)}else this.pendingSubscriptions=this.pendingSubscriptions.filter(i=>i.handler!==s);else r?this.pendingSubscriptions=this.pendingSubscriptions.filter(i=>i.event!==r):this.pendingSubscriptions=[];return t}createDelegate(){let e=new Ue.WebSocketTransport(this.options.getWsUrl());for(let{event:t,handler:r}of this.pendingSubscriptions)e.subscribe(t,r);return e}async tryConnect(){for(let e=1;e<=this.options.retries;e++)try{this.delegate||(this.delegate=this.createDelegate()),await this.delegate.connect(),a.log("Copilot#connect: Connected successfully");return}catch(t){if(a.warn(`Copilot#connect: Connection attempt ${e}/${this.options.retries} failed`,t),e===this.options.retries)throw this.delegate=void 0,this.options.showError("GitHub Copilot Connection Error","Failed to connect to GitHub Copilot. Please check your settings and try again."),t;await new Promise(r=>setTimeout(r,this.options.retryDelayMs))}}async connect(){return await this.options.waitForReady(),this.tryConnect()}close(){var e;(e=this.delegate)==null||e.close(),this.delegate=void 0}async sendData(e,t){if(!this.delegate){a.log("Copilot#sendData: Delegate not initialized, reconnecting...");try{await this.options.waitForReady(),await this.tryConnect()}catch(r){throw a.error("Copilot#sendData: Failed to reconnect transport",r),Error("Unable to connect to GitHub Copilot. Please check your settings and try again.")}}if(!this.delegate)throw Error("Failed to initialize GitHub Copilot connection. Please try again.");return t=Math.min(t??this.options.maxTimeoutMs,this.options.maxTimeoutMs),this.delegate.sendData(e,t)}};const G="/__marimo_copilot__.py";var U=`file://${G}`;const Re=g(()=>{let n=le();return new Pe({getWsUrl:()=>n.getLSPURL("copilot").toString(),waitForReady:async()=>{await qe(),await he()},showError:(e,t)=>{pe({variant:"danger",title:e,description:t})}})}),A=g(()=>new Ge({rootUri:U,workspaceFolders:null,transport:Re()}));function We(){return X({documentUri:U,client:A(),languageId:"copilot",hoverEnabled:!1,completionEnabled:!1,definitionEnabled:!1,renameEnabled:!1,codeActionsEnabled:!1,signatureHelpEnabled:!1,diagnosticsEnabled:!1,sendIncrementalChanges:!1})}export{I as a,Ne as c,Oe as i,Se as l,We as n,C as o,A as r,_ as s,G as t,Ee as u};
