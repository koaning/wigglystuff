var w=Object.defineProperty;var S=(t,e,r)=>e in t?w(t,e,{enumerable:!0,configurable:!0,writable:!0,value:r}):t[e]=r;var R=(t,e,r)=>S(t,typeof e!="symbol"?e+"":e,r);import{i as T,l as d,n as g,o as C,p as i,u as y}from"./useEvent-BhXAndur.js";import{t as D}from"./compiler-runtime-B3qBwwSJ.js";import{d as c}from"./hotkeys-BHHWjLlp.js";import{t as I}from"./utils-YqBXNpsM.js";import{r as l}from"./constants-B6Cb__3x.js";import{t as A}from"./Deferred-DxQeE5uh.js";import{t as f}from"./session-BOFn9QrD.js";function m(){return typeof document<"u"&&document.querySelector("marimo-wasm")!==null}const n={NOT_STARTED:"NOT_STARTED",CONNECTING:"CONNECTING",OPEN:"OPEN",CLOSING:"CLOSING",CLOSED:"CLOSED"},P={KERNEL_DISCONNECTED:"KERNEL_DISCONNECTED",ALREADY_RUNNING:"ALREADY_RUNNING",MALFORMED_QUERY:"MALFORMED_QUERY",KERNEL_STARTUP_ERROR:"KERNEL_STARTUP_ERROR"},o=i({state:n.NOT_STARTED});function _(){return C(o,t=>t.state===n.OPEN)}const b=i(t=>t(o).state===n.CONNECTING);i(t=>t(o).state===n.OPEN);const G=i(t=>{let e=t(o);return e.state===n.OPEN||e.state===n.NOT_STARTED}),W=i(t=>t(o).state===n.CLOSED),k=i(t=>t(o).state===n.NOT_STARTED);function H(t){return t===n.CLOSED}function $(t){return t===n.CONNECTING}function M(t){return t===n.OPEN}function v(t){return t===n.CLOSING}function L(t){return t===n.NOT_STARTED}function z(t){return t===n.CLOSED||t===n.CLOSING||t===n.CONNECTING}function F(t){switch(t){case n.CLOSED:return"App disconnected";case n.CONNECTING:return"Connecting to a runtime ...";case n.CLOSING:return"App disconnecting...";case n.OPEN:return"";case n.NOT_STARTED:return"Click to connect to a runtime";default:return""}}var x=class{constructor(t,e=!1){R(this,"initialHealthyCheck",new A);this.config=t,this.lazy=e;try{new URL(this.config.url)}catch(r){throw Error(`Invalid runtime URL: ${this.config.url}. ${r instanceof Error?r.message:"Unknown error"}`)}this.lazy||this.init()}get isLazy(){return this.lazy}get httpURL(){return new URL(this.config.url)}get isSameOrigin(){return this.httpURL.origin===window.location.origin}formatHttpURL(t,e,r=!0){t||(t="");let a=this.httpURL,s=new URLSearchParams(window.location.search);if(e)for(let[h,u]of e.entries())a.searchParams.set(h,u);for(let[h,u]of s.entries())r&&!Object.values(l).includes(h)||a.searchParams.set(h,u);return a.pathname=`${a.pathname.replace(/\/$/,"")}/${t.replace(/^\//,"")}`,a.hash="",a}formatWsURL(t,e){return K(this.formatHttpURL(t,e,!1).toString())}getWsURL(t){let e=new URL(this.config.url),r=new URLSearchParams(e.search);return new URLSearchParams(window.location.search).forEach((a,s)=>{r.has(s)||r.set(s,a)}),r.set(l.sessionId,t),this.formatWsURL("/ws",r)}getWsSyncURL(t){let e=new URL(this.config.url),r=new URLSearchParams(e.search);return new URLSearchParams(window.location.search).forEach((a,s)=>{r.has(s)||r.set(s,a)}),r.set(l.sessionId,t),this.formatWsURL("/ws_sync",r)}getTerminalWsURL(){return this.formatWsURL("/terminal/ws")}getLSPURL(t){if(t==="copilot"){let e=this.formatWsURL(`/lsp/${t}`);return e.search="",e}return this.formatWsURL(`/lsp/${t}`)}getAiURL(t){return this.formatHttpURL(`/api/ai/${t}`)}healthURL(){return this.formatHttpURL("/health")}async isHealthy(){if(m()||I())return!0;try{let t=await fetch(this.healthURL().toString());if(t.redirected){c.debug(`Runtime redirected to ${t.url}`);let r=t.url.replace(/\/health$/,"");this.config.url=r}let e=t.ok;return e&&this.setDOMBaseUri(this.config.url),e}catch{return!1}}setDOMBaseUri(t){t=t.split("?",1)[0],t.endsWith("/")||(t+="/");let e=document.querySelector("base");e?e.setAttribute("href",t):(e=document.createElement("base"),e.setAttribute("href",t),document.head.append(e))}async init(t){c.debug("Initializing runtime...");let e=0;for(;!await this.isHealthy();){if(e>=25){c.error("Failed to connect after 25 retries"),this.initialHealthyCheck.reject(Error("Failed to connect after 25 retries"));return}if(!(t!=null&&t.disableRetryDelay)){let r=Math.min(100*1.2**e,2e3);await new Promise(a=>setTimeout(a,r))}e++}c.debug("Runtime is healthy"),this.initialHealthyCheck.resolve()}async waitForHealthy(){return this.initialHealthyCheck.promise}headers(){let t={"Marimo-Session-Id":f(),"Marimo-Server-Token":this.config.serverToken??"","x-runtime-url":this.httpURL.toString()};return this.config.authToken&&(t.Authorization=`Bearer ${this.config.authToken}`),t}sessionHeaders(){return{"Marimo-Session-Id":f()}}};function K(t){if(!t.startsWith("http")){c.warn(`URL must start with http: ${t}`);let e=new URL(t);return e.protocol="ws",e}return new URL(t.replace(/^http/,"ws"))}var Y=D();function j(){let t=new URL(document.baseURI);return t.search="",t.hash="",t.toString()}const N={lazy:!0,url:j()},E=i(N);var U=i(t=>{let e=t(E);return new x(e,e.lazy)});function p(){return y(U)}function B(){let t=(0,Y.c)(4),e=p(),[r,a]=d(o),s;return t[0]!==r.state||t[1]!==e||t[2]!==a?(s=async()=>{L(r.state)?(a({state:n.CONNECTING}),await e.init()):c.log("Runtime already started or starting...")},t[0]=r.state,t[1]=e,t[2]=a,t[3]=s):s=t[3],g(s)}function O(){return T.get(U)}function q(t){if(t.startsWith("http"))return new URL(t);let e=O().httpURL.toString();return e.startsWith("blob:")&&(e=e.replace("blob:","")),new URL(t,e)}export{m as S,b as _,B as a,P as b,H as c,$ as d,z as f,W as g,o as h,E as i,v as l,G as m,q as n,p as o,L as p,O as r,F as s,N as t,M as u,k as v,n as x,_ as y};
