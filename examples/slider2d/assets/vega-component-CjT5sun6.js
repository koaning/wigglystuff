import{s as Z}from"./chunk-LvLJmgfZ.js";import"./jotai-D74Ef_p1.js";import{t as Y}from"./react-XTZdWHwa.js";import"./react-dom-BZDtXk6t.js";import"./zod-BBqism5D.js";import{t as tt}from"./compiler-runtime-QczY1yfQ.js";import"./_Uint8Array-BGESiCQL.js";import"./isSymbol-BGkTcW3U.js";import"./toNumber-GB_lFVaq.js";import"./isArrayLikeObject-BkJc8lDE.js";import"./_getTag-BWqNuuwU.js";import"./_baseUniq-DmLB0Hft.js";import"./_baseIsEqual-C8v2yRqO.js";import"./merge-DVX6Ez37.js";import"./now-DBnXnRPe.js";import{t as rt}from"./debounce-BzCP2SOK.js";import{r as et,t as nt}from"./tooltip-tPIJZni7.js";import{t as j}from"./uniq-CwfSRyIn.js";import{a as V,u as A}from"./hotkeys-sK-kaEBC.js";import"./invariant-EWlZS5z8.js";import"./utils-Clm_pCuX.js";import"./constants-Bt6NlroV.js";import{n as F}from"./config-BwUC_LRl.js";import"./useEventListener-BMXqdHZ5.js";import{t as at}from"./jsx-runtime-B4_2-8Ho.js";import{r as it}from"./button-BtVgadIf.js";import"./clsx-CGw3WJH5.js";import"./cn-f3ruLt4G.js";import"./createLucideIcon-C9QGcv--.js";import{u as ot}from"./toDate-J43JkZRd.js";import"./Deferred-cELqHKYi.js";import{n as lt}from"./useTheme-DNzypnwR.js";import"./Combination-DIF6wDxT.js";import"./dist-DTKIwXcy.js";import{t as st}from"./tooltip-DEUNsdbK.js";import{t as ct}from"./isValid-CB2nX3F0.js";import"./alert-dialog-CYJZg0vV.js";import{n as P}from"./useEvent-bc5jSpSz.js";import{n as mt}from"./error-banner-BVpxvuDQ.js";import{n as pt}from"./vega-loader.browser-DUgPL0IU.js";import"./precisionRound-BdwMj645.js";import"./linear-BQs_BJbB.js";import{t as ut}from"./react-vega-BAaWsGgr.js";import"./ordinal-6cy7Wi6n.js";import"./time-BI36HTF4.js";import"./range-CBESds6M.js";import"./defaultLocale-9ao8Dcla.js";import"./defaultLocale-Bu1vZnwX.js";import{r as ft,t as dt}from"./alert-BP5lLEUu.js";import{n as ht}from"./useAsyncData-CWTnKpYp.js";import"./dist-CSLSra8C.js";import{t as H}from"./useDeepCompareMemoize-CMu624yo.js";import{t as gt}from"./formats-C_m3CfBz.js";import"./timer-CjInJf90.js";import"./path-Whqm9ggf.js";import"./math-CJEhL5Or.js";import"./arc-Ds_Zv0QO.js";import"./array-BLCDwreq.js";import"./step-Cy9SLim8.js";import"./line-BXY1-slS.js";import"./init-MQWkw9UL.js";import"./colors-DdaNPisK.js";import"./treemap-C4MB7fhl.js";var yt=tt(),b=Z(Y(),1);function vt(t){return t.data&&"url"in t.data&&(t.data.url=F(t.data.url).href),t}const u={arc:"arc",area:"area",bar:"bar",image:"image",line:"line",point:"point",rect:"rect",rule:"rule",text:"text",tick:"tick",trail:"trail",circle:"circle",square:"square",geoshape:"geoshape"};var W=new Set(["boxplot","errorband","errorbar"]);const w={getMarkType(t){let r=typeof t=="string"?t:t.type;if(W.has(r))throw Error("Not supported");return r},isInteractive(t){let r=typeof t=="string"?t:t.type;return!W.has(r)},makeClickable(t){let r=typeof t=="string"?t:t.type;return r in u?typeof t=="string"?{type:t,cursor:"pointer",tooltip:!0}:{...t,type:r,cursor:"pointer",tooltip:!0}:t},getOpacity(t){return typeof t=="string"?null:"opacity"in t&&typeof t.opacity=="number"?t.opacity:null}},g={point(t){return t==null?"select_point":`select_point_${t}`},interval(t){return t==null?"select_interval":`select_interval_${t}`},legendSelection(t){return`legend_selection_${t}`},binColoring(t){return t==null?"bin_coloring":`bin_coloring_${t}`},HIGHLIGHT:"highlight",PAN_ZOOM:"pan_zoom",hasPoint(t){return t.some(r=>r.startsWith("select_point"))},hasInterval(t){return t.some(r=>r.startsWith("select_interval"))},hasLegend(t){return t.some(r=>r.startsWith("legend_selection"))},hasPanZoom(t){return t.some(r=>r.startsWith("pan_zoom"))},isBinColoring(t){return t.startsWith("bin_coloring")}},O={highlight(){return{name:g.HIGHLIGHT,select:{type:"point",on:"mouseover"}}},interval(t,r){return{name:g.interval(r),select:{type:"interval",encodings:D(t),mark:{fill:"#669EFF",fillOpacity:.07,stroke:"#669EFF",strokeOpacity:.4},on:"[mousedown[!event.metaKey], mouseup] > mousemove[!event.metaKey]",translate:"[mousedown[!event.metaKey], mouseup] > mousemove[!event.metaKey]"}}},point(t,r){return{name:g.point(r),select:{type:"point",encodings:D(t),on:"click[!event.metaKey]"}}},binColoring(t){return{name:g.binColoring(t),select:{type:"point",on:"click[!event.metaKey]"}}},legend(t){return{name:g.legendSelection(t),select:{type:"point",fields:[t]},bind:"legend"}},panZoom(){return{name:g.PAN_ZOOM,bind:"scales",select:{type:"interval",on:"[mousedown[event.metaKey], window:mouseup] > window:mousemove!",translate:"[mousedown[event.metaKey], window:mouseup] > window:mousemove!",zoom:"wheel![event.metaKey]"}}}};function D(t){switch(w.getMarkType(t.mark)){case u.image:case u.trail:return;case u.area:case u.arc:return["color"];case u.bar:{let r=kt(t);return r==="horizontal"?["y"]:r==="vertical"?["x"]:void 0}case u.circle:case u.geoshape:case u.line:case u.point:case u.rect:case u.rule:case u.square:case u.text:case u.tick:return["x","y"]}}function M(t){return"params"in t&&t.params&&t.params.length>0?j(t.params.filter(r=>r==null?!1:"select"in r&&r.select!==void 0).map(r=>r.name)):"layer"in t?j(t.layer.flatMap(M)):"vconcat"in t?j(t.vconcat.flatMap(M)):"hconcat"in t?j(t.hconcat.flatMap(M)):[]}function kt(t){var a,e;if(!t||!("mark"in t))return;let r=(a=t.encoding)==null?void 0:a.x,n=(e=t.encoding)==null?void 0:e.y;if(r&&"type"in r&&r.type==="nominal")return"vertical";if(n&&"type"in n&&n.type==="nominal"||r&&"aggregate"in r)return"horizontal";if(n&&"aggregate"in n)return"vertical"}function bt(t){if(!t.encoding)return[];let r=[];for(let n of Object.values(t.encoding))n&&typeof n=="object"&&"bin"in n&&n.bin&&"field"in n&&typeof n.field=="string"&&r.push(n.field);return r}function G(t){if(!t||!("encoding"in t))return[];let{encoding:r}=t;return r?Object.entries(r).flatMap(n=>{let[a,e]=n;return!e||!wt.has(a)?[]:"field"in e&&typeof e.field=="string"?[e.field]:"condition"in e&&e.condition&&typeof e.condition=="object"&&"field"in e.condition&&e.condition.field&&typeof e.condition.field=="string"?[e.condition.field]:[]}):[]}var wt=new Set(["color","fill","fillOpacity","opacity","shape","size"]);function $(t,r,n,a){let e=n.filter(s=>g.isBinColoring(s)),i={and:(e.length>0?e:n).map(s=>({param:s}))};switch(t){case"opacity":{let s=w.getOpacity(a)||1;return{...r,opacity:{condition:{test:i,value:s},value:s/5}}}default:return r}}function xt(t){if(!("select"in t)||!t.select)return JSON.stringify(t);let r=t.select;if(typeof r=="string")return JSON.stringify({type:r,bind:t.bind});let n={type:r.type,encodings:"encodings"in r&&r.encodings?[...r.encodings].sort():void 0,fields:"fields"in r&&r.fields?[...r.fields].sort():void 0,bind:t.bind};return JSON.stringify(n)}function q(t){let r=I(t);if(r.length===0)return t;let n=St(r);return n.length===0?t:{...K(C(t,new Set(n.map(a=>a.name))),n.map(a=>a.name)),params:[...t.params||[],...n]}}function I(t){let r=[];if("vconcat"in t&&Array.isArray(t.vconcat))for(let n of t.vconcat)r.push(...I(n));else if("hconcat"in t&&Array.isArray(t.hconcat))for(let n of t.hconcat)r.push(...I(n));else{if("layer"in t)return[];"mark"in t&&"params"in t&&t.params&&t.params.length>0&&r.push({params:t.params})}return r}function St(t){if(t.length===0)return[];let r=new Map,n=t.length;for(let{params:e}of t){let i=new Set;for(let s of e){let o=xt(s);i.has(o)||(i.add(o),r.has(o)||r.set(o,{count:0,param:s}),r.get(o).count++)}}let a=[];for(let[,{count:e,param:i}]of r)e===n&&a.push(i);return a}function C(t,r){if("vconcat"in t&&Array.isArray(t.vconcat))return{...t,vconcat:t.vconcat.map(n=>C(n,r))};if("hconcat"in t&&Array.isArray(t.hconcat))return{...t,hconcat:t.hconcat.map(n=>C(n,r))};if("mark"in t&&"params"in t&&t.params){let n=t.params,a=[];for(let e of n){if(!e||typeof e!="object"||!("name"in e)){a.push(e);continue}r.has(e.name)||a.push(e)}if(a.length===0){let{params:e,...i}=t;return i}return{...t,params:a}}return t}function K(t,r){return"vconcat"in t&&Array.isArray(t.vconcat)?{...t,vconcat:t.vconcat.map(n=>K(n,r))}:"hconcat"in t&&Array.isArray(t.hconcat)?{...t,hconcat:t.hconcat.map(n=>K(n,r))}:"layer"in t?t:"mark"in t&&w.isInteractive(t.mark)?{...t,mark:w.makeClickable(t.mark),encoding:$("opacity",t.encoding||{},r,t.mark)}:t}function E(t,r){var i,s;let{chartSelection:n=!0,fieldSelection:a=!0}=r;if(!n&&!a)return t;if((i=t.params)!=null&&i.some(o=>o.bind==="legend")&&(a=!1),(s=t.params)!=null&&s.some(o=>!o.bind)&&(n=!1),"vconcat"in t){let o=t.vconcat.map(m=>"mark"in m?E(m,{chartSelection:n,fieldSelection:a}):m);return q({...t,vconcat:o})}if("hconcat"in t){let o=t.hconcat.map(m=>"mark"in m?E(m,{chartSelection:n,fieldSelection:a}):m);return q({...t,hconcat:o})}if("layer"in t){let o=t.params&&t.params.length>0,m=a!==!1&&!o,f=[];if(m){let y=t.layer.flatMap(p=>"mark"in p?G(p):[]);f=[...new Set(y)],Array.isArray(a)&&(f=f.filter(p=>a.includes(p)))}let k=t.layer.map((y,p)=>{if(!("mark"in y))return y;let c=y;if(p===0&&f.length>0){let x=f.map(_=>O.legend(_));c={...c,params:[...c.params||[],...x]}}return c=z(c,n,p),c=J(c),p===0&&(c=B(c)),c});return{...t,layer:k}}if(!("mark"in t)||!w.isInteractive(t.mark))return t;let e=t;return e=At(e,a),e=z(e,n,void 0),e=J(e),e=B(e),e}function At(t,r){if(r===!1)return t;let n=G(t);Array.isArray(r)&&(n=n.filter(i=>r.includes(i)));let a=n.map(i=>O.legend(i)),e=[...t.params||[],...a];return{...t,params:e}}function z(t,r,n){if(r===!1)return t;let a;try{a=w.getMarkType(t.mark)}catch{return t}if(a==="geoshape")return t;let e=bt(t),i=r===!0?e.length>0?["point"]:Ot(a):[r];if(!i||i.length===0)return t;let s=i.map(m=>m==="interval"?O.interval(t,n):O.point(t,n)),o=[...t.params||[],...s];return e.length>0&&i.includes("point")&&o.push(O.binColoring(n)),{...t,params:o}}function B(t){let r;try{r=w.getMarkType(t.mark)}catch{}if(r==="geoshape")return t;let n=t.params||[];return n.some(a=>a.bind==="scales")?t:{...t,params:[...n,O.panZoom()]}}function J(t){let r="encoding"in t?t.encoding:void 0,n=t.params||[],a=n.map(e=>e.name);return n.length===0||!w.isInteractive(t.mark)?t:{...t,mark:w.makeClickable(t.mark),encoding:$("opacity",r||{},a,t.mark)}}function Ot(t){switch(t){case"arc":case"area":return["point"];case"text":case"bar":return["point","interval"];case"line":return;default:return["point","interval"]}}async function _t(t){if(!t)return t;let r="datasets"in t?{...t.datasets}:{},n=async e=>{if(!e)return e;if("layer"in e){let o=await Promise.all(e.layer.map(n));e={...e,layer:o}}if("hconcat"in e){let o=await Promise.all(e.hconcat.map(n));e={...e,hconcat:o}}if("vconcat"in e){let o=await Promise.all(e.vconcat.map(n));e={...e,vconcat:o}}if("spec"in e&&(e={...e,spec:await n(e.spec)}),!e.data||!("url"in e.data))return e;let i;try{i=F(e.data.url)}catch{return e}let s=await et(i.href,e.data.format);return r[i.pathname]=s,{...e,data:{name:i.pathname}}},a=await n(t);return Object.keys(r).length===0?a:{...a,datasets:r}}var d=Z(at(),1);pt("arrow",gt);var jt=t=>{let r=(0,yt.c)(12),{value:n,setValue:a,chartSelection:e,fieldSelection:i,spec:s,embedOptions:o}=t,m,f;r[0]===s?(m=r[1],f=r[2]):(m=async()=>_t(s),f=[s],r[0]=s,r[1]=m,r[2]=f);let{data:k,error:y}=ht(m,f);if(y){let c;return r[3]===y?c=r[4]:(c=(0,d.jsx)(mt,{error:y}),r[3]=y,r[4]=c),c}if(!k)return null;let p;return r[5]!==e||r[6]!==o||r[7]!==i||r[8]!==k||r[9]!==a||r[10]!==n?(p=(0,d.jsx)(Mt,{value:n,setValue:a,chartSelection:e,fieldSelection:i,spec:k,embedOptions:o}),r[5]=e,r[6]=o,r[7]=i,r[8]=k,r[9]=a,r[10]=n,r[11]=p):p=r[11],p},Mt=({value:t,setValue:r,chartSelection:n,fieldSelection:a,spec:e,embedOptions:i})=>{let{theme:s}=lt(),o=(0,b.useRef)(null),m=(0,b.useRef)(void 0),[f,k]=(0,b.useState)(),y=(0,b.useMemo)(()=>i&&"actions"in i?i.actions:{source:!1,compiled:!1},[i]),p=H(e),c=(0,b.useMemo)(()=>E(vt(p),{chartSelection:n,fieldSelection:a}),[p,n,a]),x=(0,b.useMemo)(()=>M(c),[c]),_=P(l=>{r({...t,...l})}),L=(0,b.useMemo)(()=>rt((l,h)=>{A.debug("[Vega signal]",l,h);let v=V.mapValues(h,Pt);v=V.mapValues(v,Nt),_({[l]:v})},100),[_]),T=H(x),N=(0,b.useMemo)(()=>T.reduce((l,h)=>(g.PAN_ZOOM===h||g.isBinColoring(h)||l.push({signalName:h,handler:(v,X)=>L(v,X)}),l),[]),[T,L]),R=P(l=>{A.error(l),A.debug(c),k(l)}),Q=P(l=>{A.debug("[Vega view] created",l),m.current=l,k(void 0)}),U=()=>{let l=[];return g.hasPoint(x)&&l.push(["Point selection","click to select a point; hold shift for multi-select"]),g.hasInterval(x)&&l.push(["Interval selection","click and drag to select an interval"]),g.hasLegend(x)&&l.push(["Legend selection","click to select a legend item; hold shift for multi-select"]),g.hasPanZoom(x)&&l.push(["Pan","hold the meta key and drag"],["Zoom","hold the meta key and scroll"]),l.length===0?null:(0,d.jsx)(st,{delayDuration:300,side:"left",content:(0,d.jsx)("div",{className:"text-xs flex flex-col",children:l.map((h,v)=>(0,d.jsxs)("div",{children:[(0,d.jsxs)("span",{className:"font-bold tracking-wide",children:[h[0],":"]})," ",h[1]]},v))}),children:(0,d.jsx)(ot,{className:"absolute bottom-1 right-0 m-2 h-4 w-4 cursor-help text-muted-foreground hover:text-foreground"})})},S=ut({ref:o,spec:c,options:{theme:s==="dark"?"dark":void 0,actions:y,mode:"vega-lite",tooltip:nt.call,renderer:"canvas"},onError:R,onEmbed:Q});return(0,b.useEffect)(()=>(N.forEach(({signalName:l,handler:h})=>{try{S==null||S.view.addSignalListener(l,h)}catch(v){A.error(v)}}),()=>{N.forEach(({signalName:l,handler:h})=>{try{S==null||S.view.removeSignalListener(l,h)}catch(v){A.error(v)}})}),[S,N]),(0,d.jsxs)(d.Fragment,{children:[f&&(0,d.jsxs)(dt,{variant:"destructive",children:[(0,d.jsx)(ft,{children:f.message}),(0,d.jsx)("div",{className:"text-md",children:f.stack})]}),(0,d.jsxs)("div",{className:"relative",onPointerDown:it.stopPropagation(),children:[(0,d.jsx)("div",{ref:o}),U()]})]})};function Nt(t){return t instanceof Set?[...t]:t}function Pt(t){return Array.isArray(t)?t.map(r=>r instanceof Date&&ct(r)?new Date(r).getTime():r):t}var It=jt;export{It as default};
