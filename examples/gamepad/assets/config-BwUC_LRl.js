var st=Object.defineProperty;var at=(t,n,h)=>n in t?st(t,n,{enumerable:!0,configurable:!0,writable:!0,value:h}):t[n]=h;var N=(t,n,h)=>at(t,typeof n!="symbol"?n+"":n,h);import{t as $}from"./chunk-LvLJmgfZ.js";import{c as ht,d as z,n as ut}from"./jotai-D74Ef_p1.js";import{u as j}from"./hotkeys-sK-kaEBC.js";import{t as ct}from"./invariant-EWlZS5z8.js";import{t as lt}from"./utils-Clm_pCuX.js";import{n as W}from"./constants-Bt6NlroV.js";import{t as ft}from"./Deferred-cELqHKYi.js";function V(){return typeof document<"u"&&document.querySelector("marimo-wasm")!==null}function q(){return(window==null?void 0:window.__MARIMO_STATIC__)!==void 0}function dt(){return ct(window.__MARIMO_STATIC__!==void 0,"Not a static notebook"),window.__MARIMO_STATIC__.files}var pt=$((t=>{Object.defineProperty(t,"__esModule",{value:!0}),t.toBig=t.shrSL=t.shrSH=t.rotrSL=t.rotrSH=t.rotrBL=t.rotrBH=t.rotr32L=t.rotr32H=t.rotlSL=t.rotlSH=t.rotlBL=t.rotlBH=t.add5L=t.add5H=t.add4L=t.add4H=t.add3L=t.add3H=void 0,t.add=y,t.fromBig=p,t.split=f;var n=BigInt(2**32-1),h=BigInt(32);function p(o,i=!1){return i?{h:Number(o&n),l:Number(o>>h&n)}:{h:Number(o>>h&n)|0,l:Number(o&n)|0}}function f(o,i=!1){let e=o.length,l=new Uint32Array(e),S=new Uint32Array(e);for(let x=0;x<e;x++){let{h:T,l:F}=p(o[x],i);[l[x],S[x]]=[T,F]}return[l,S]}var k=(o,i)=>BigInt(o>>>0)<<h|BigInt(i>>>0);t.toBig=k;var U=(o,i,e)=>o>>>e;t.shrSH=U;var O=(o,i,e)=>o<<32-e|i>>>e;t.shrSL=O;var A=(o,i,e)=>o>>>e|i<<32-e;t.rotrSH=A;var M=(o,i,e)=>o<<32-e|i>>>e;t.rotrSL=M;var R=(o,i,e)=>o<<64-e|i>>>e-32;t.rotrBH=R;var B=(o,i,e)=>o>>>e-32|i<<64-e;t.rotrBL=B;var E=(o,i)=>i;t.rotr32H=E;var P=(o,i)=>o;t.rotr32L=P;var H=(o,i,e)=>o<<e|i>>>32-e;t.rotlSH=H;var _=(o,i,e)=>i<<e|o>>>32-e;t.rotlSL=_;var d=(o,i,e)=>i<<e-32|o>>>64-e;t.rotlBH=d;var L=(o,i,e)=>o<<e-32|i>>>64-e;t.rotlBL=L;function y(o,i,e,l){let S=(i>>>0)+(l>>>0);return{h:o+e+(S/2**32|0)|0,l:S|0}}var w=(o,i,e)=>(o>>>0)+(i>>>0)+(e>>>0);t.add3L=w;var C=(o,i,e,l)=>i+e+l+(o/2**32|0)|0;t.add3H=C;var c=(o,i,e,l)=>(o>>>0)+(i>>>0)+(e>>>0)+(l>>>0);t.add4L=c;var s=(o,i,e,l,S)=>i+e+l+S+(o/2**32|0)|0;t.add4H=s;var u=(o,i,e,l,S)=>(o>>>0)+(i>>>0)+(e>>>0)+(l>>>0)+(S>>>0);t.add5L=u;var g=(o,i,e,l,S,x)=>i+e+l+S+x+(o/2**32|0)|0;t.add5H=g,t.default={fromBig:p,split:f,toBig:k,shrSH:U,shrSL:O,rotrSH:A,rotrSL:M,rotrBH:R,rotrBL:B,rotr32H:E,rotr32L:P,rotlSH:H,rotlSL:_,rotlBH:d,rotlBL:L,add:y,add3L:w,add3H:C,add4L:c,add4H:s,add5H:g,add5L:u}})),gt=$((t=>{Object.defineProperty(t,"__esModule",{value:!0}),t.crypto=void 0,t.crypto=typeof globalThis=="object"&&"crypto"in globalThis?globalThis.crypto:void 0})),wt=$((t=>{Object.defineProperty(t,"__esModule",{value:!0}),t.wrapXOFConstructorWithOpts=t.wrapConstructorWithOpts=t.wrapConstructor=t.Hash=t.nextTick=t.swap32IfBE=t.byteSwapIfBE=t.swap8IfBE=t.isLE=void 0,t.isBytes=h,t.anumber=p,t.abytes=f,t.ahash=k,t.aexists=U,t.aoutput=O,t.u8=A,t.u32=M,t.clean=R,t.createView=B,t.rotr=E,t.rotl=P,t.byteSwap=H,t.byteSwap32=_,t.bytesToHex=y,t.hexToBytes=c,t.asyncLoop=s,t.utf8ToBytes=u,t.bytesToUtf8=g,t.toBytes=o,t.kdfInputToBytes=i,t.concatBytes=e,t.checkOpts=l,t.createHasher=S,t.createOptHasher=x,t.createXOFer=T,t.randomBytes=F;var n=gt();function h(r){return r instanceof Uint8Array||ArrayBuffer.isView(r)&&r.constructor.name==="Uint8Array"}function p(r){if(!Number.isSafeInteger(r)||r<0)throw Error("positive integer expected, got "+r)}function f(r,...a){if(!h(r))throw Error("Uint8Array expected");if(a.length>0&&!a.includes(r.length))throw Error("Uint8Array expected of length "+a+", got length="+r.length)}function k(r){if(typeof r!="function"||typeof r.create!="function")throw Error("Hash should be wrapped by utils.createHasher");p(r.outputLen),p(r.blockLen)}function U(r,a=!0){if(r.destroyed)throw Error("Hash instance has been destroyed");if(a&&r.finished)throw Error("Hash#digest() has already been called")}function O(r,a){f(r);let m=a.outputLen;if(r.length<m)throw Error("digestInto() expects output buffer of length at least "+m)}function A(r){return new Uint8Array(r.buffer,r.byteOffset,r.byteLength)}function M(r){return new Uint32Array(r.buffer,r.byteOffset,Math.floor(r.byteLength/4))}function R(...r){for(let a=0;a<r.length;a++)r[a].fill(0)}function B(r){return new DataView(r.buffer,r.byteOffset,r.byteLength)}function E(r,a){return r<<32-a|r>>>a}function P(r,a){return r<<a|r>>>32-a>>>0}t.isLE=new Uint8Array(new Uint32Array([287454020]).buffer)[0]===68;function H(r){return r<<24&4278190080|r<<8&16711680|r>>>8&65280|r>>>24&255}t.swap8IfBE=t.isLE?r=>r:r=>H(r),t.byteSwapIfBE=t.swap8IfBE;function _(r){for(let a=0;a<r.length;a++)r[a]=H(r[a]);return r}t.swap32IfBE=t.isLE?r=>r:_;var d=typeof Uint8Array.from([]).toHex=="function"&&typeof Uint8Array.fromHex=="function",L=Array.from({length:256},(r,a)=>a.toString(16).padStart(2,"0"));function y(r){if(f(r),d)return r.toHex();let a="";for(let m=0;m<r.length;m++)a+=L[r[m]];return a}var w={_0:48,_9:57,A:65,F:70,a:97,f:102};function C(r){if(r>=w._0&&r<=w._9)return r-w._0;if(r>=w.A&&r<=w.F)return r-(w.A-10);if(r>=w.a&&r<=w.f)return r-(w.a-10)}function c(r){if(typeof r!="string")throw Error("hex string expected, got "+typeof r);if(d)return Uint8Array.fromHex(r);let a=r.length,m=a/2;if(a%2)throw Error("hex string expected, got unpadded hex of length "+a);let b=new Uint8Array(m);for(let v=0,I=0;v<m;v++,I+=2){let D=C(r.charCodeAt(I)),X=C(r.charCodeAt(I+1));if(D===void 0||X===void 0){let it=r[I]+r[I+1];throw Error('hex string expected, got non-hex character "'+it+'" at index '+I)}b[v]=D*16+X}return b}t.nextTick=async()=>{};async function s(r,a,m){let b=Date.now();for(let v=0;v<r;v++){m(v);let I=Date.now()-b;I>=0&&I<a||(await(0,t.nextTick)(),b+=I)}}function u(r){if(typeof r!="string")throw Error("string expected");return new Uint8Array(new TextEncoder().encode(r))}function g(r){return new TextDecoder().decode(r)}function o(r){return typeof r=="string"&&(r=u(r)),f(r),r}function i(r){return typeof r=="string"&&(r=u(r)),f(r),r}function e(...r){let a=0;for(let b=0;b<r.length;b++){let v=r[b];f(v),a+=v.length}let m=new Uint8Array(a);for(let b=0,v=0;b<r.length;b++){let I=r[b];m.set(I,v),v+=I.length}return m}function l(r,a){if(a!==void 0&&{}.toString.call(a)!=="[object Object]")throw Error("options should be object or undefined");return Object.assign(r,a)}t.Hash=class{};function S(r){let a=b=>r().update(o(b)).digest(),m=r();return a.outputLen=m.outputLen,a.blockLen=m.blockLen,a.create=()=>r(),a}function x(r){let a=(b,v)=>r(v).update(o(b)).digest(),m=r({});return a.outputLen=m.outputLen,a.blockLen=m.blockLen,a.create=b=>r(b),a}function T(r){let a=(b,v)=>r(v).update(o(b)).digest(),m=r({});return a.outputLen=m.outputLen,a.blockLen=m.blockLen,a.create=b=>r(b),a}t.wrapConstructor=S,t.wrapConstructorWithOpts=x,t.wrapXOFConstructorWithOpts=T;function F(r=32){if(n.crypto&&typeof n.crypto.getRandomValues=="function")return n.crypto.getRandomValues(new Uint8Array(r));if(n.crypto&&typeof n.crypto.randomBytes=="function")return Uint8Array.from(n.crypto.randomBytes(r));throw Error("crypto.getRandomValues must be defined")}})),yt=$((t=>{Object.defineProperty(t,"__esModule",{value:!0}),t.shake256=t.shake128=t.keccak_512=t.keccak_384=t.keccak_256=t.keccak_224=t.sha3_512=t.sha3_384=t.sha3_256=t.sha3_224=t.Keccak=void 0,t.keccakP=L;var n=pt(),h=wt(),p=BigInt(0),f=BigInt(1),k=BigInt(2),U=BigInt(7),O=BigInt(256),A=BigInt(113),M=[],R=[],B=[];for(let c=0,s=f,u=1,g=0;c<24;c++){[u,g]=[g,(2*u+3*g)%5],M.push(2*(5*g+u)),R.push((c+1)*(c+2)/2%64);let o=p;for(let i=0;i<7;i++)s=(s<<f^(s>>U)*A)%O,s&k&&(o^=f<<(f<<BigInt(i))-f);B.push(o)}var E=(0,n.split)(B,!0),P=E[0],H=E[1],_=(c,s,u)=>u>32?(0,n.rotlBH)(c,s,u):(0,n.rotlSH)(c,s,u),d=(c,s,u)=>u>32?(0,n.rotlBL)(c,s,u):(0,n.rotlSL)(c,s,u);function L(c,s=24){let u=new Uint32Array(10);for(let g=24-s;g<24;g++){for(let e=0;e<10;e++)u[e]=c[e]^c[e+10]^c[e+20]^c[e+30]^c[e+40];for(let e=0;e<10;e+=2){let l=(e+8)%10,S=(e+2)%10,x=u[S],T=u[S+1],F=_(x,T,1)^u[l],r=d(x,T,1)^u[l+1];for(let a=0;a<50;a+=10)c[e+a]^=F,c[e+a+1]^=r}let o=c[2],i=c[3];for(let e=0;e<24;e++){let l=R[e],S=_(o,i,l),x=d(o,i,l),T=M[e];o=c[T],i=c[T+1],c[T]=S,c[T+1]=x}for(let e=0;e<50;e+=10){for(let l=0;l<10;l++)u[l]=c[e+l];for(let l=0;l<10;l++)c[e+l]^=~u[(l+2)%10]&u[(l+4)%10]}c[0]^=P[g],c[1]^=H[g]}(0,h.clean)(u)}var y=class ot extends h.Hash{constructor(s,u,g,o=!1,i=24){if(super(),this.pos=0,this.posOut=0,this.finished=!1,this.destroyed=!1,this.enableXOF=!1,this.blockLen=s,this.suffix=u,this.outputLen=g,this.enableXOF=o,this.rounds=i,(0,h.anumber)(g),!(0<s&&s<200))throw Error("only keccak-f1600 function is supported");this.state=new Uint8Array(200),this.state32=(0,h.u32)(this.state)}clone(){return this._cloneInto()}keccak(){(0,h.swap32IfBE)(this.state32),L(this.state32,this.rounds),(0,h.swap32IfBE)(this.state32),this.posOut=0,this.pos=0}update(s){(0,h.aexists)(this),s=(0,h.toBytes)(s),(0,h.abytes)(s);let{blockLen:u,state:g}=this,o=s.length;for(let i=0;i<o;){let e=Math.min(u-this.pos,o-i);for(let l=0;l<e;l++)g[this.pos++]^=s[i++];this.pos===u&&this.keccak()}return this}finish(){if(this.finished)return;this.finished=!0;let{state:s,suffix:u,pos:g,blockLen:o}=this;s[g]^=u,u&128&&g===o-1&&this.keccak(),s[o-1]^=128,this.keccak()}writeInto(s){(0,h.aexists)(this,!1),(0,h.abytes)(s),this.finish();let u=this.state,{blockLen:g}=this;for(let o=0,i=s.length;o<i;){this.posOut>=g&&this.keccak();let e=Math.min(g-this.posOut,i-o);s.set(u.subarray(this.posOut,this.posOut+e),o),this.posOut+=e,o+=e}return s}xofInto(s){if(!this.enableXOF)throw Error("XOF is not possible for this instance");return this.writeInto(s)}xof(s){return(0,h.anumber)(s),this.xofInto(new Uint8Array(s))}digestInto(s){if((0,h.aoutput)(s,this),this.finished)throw Error("digest() was already called");return this.writeInto(s),this.destroy(),s}digest(){return this.digestInto(new Uint8Array(this.outputLen))}destroy(){this.destroyed=!0,(0,h.clean)(this.state)}_cloneInto(s){let{blockLen:u,suffix:g,outputLen:o,rounds:i,enableXOF:e}=this;return s||(s=new ot(u,g,o,e,i)),s.state32.set(this.state32),s.pos=this.pos,s.posOut=this.posOut,s.finished=this.finished,s.rounds=i,s.suffix=g,s.outputLen=o,s.enableXOF=e,s.destroyed=this.destroyed,s}};t.Keccak=y;var w=(c,s,u)=>(0,h.createHasher)(()=>new y(s,c,u));t.sha3_224=w(6,144,224/8),t.sha3_256=w(6,136,256/8),t.sha3_384=w(6,104,384/8),t.sha3_512=w(6,72,512/8),t.keccak_224=w(1,144,224/8),t.keccak_256=w(1,136,256/8),t.keccak_384=w(1,104,384/8),t.keccak_512=w(1,72,512/8);var C=(c,s,u)=>(0,h.createXOFer)((g={})=>new y(s,c,g.dkLen===void 0?u:g.dkLen,!0));t.shake128=C(31,168,128/8),t.shake256=C(31,136,256/8)})),Lt=$(((t,n)=>{var{sha3_512:h}=yt(),p=24,f=32,k=(d=4,L=Math.random)=>{let y="";for(;y.length<d;)y+=Math.floor(L()*36).toString(36);return y};function U(d){let L=0n;for(let y of d.values()){let w=BigInt(y);L=(L<<8n)+w}return L}var O=(d="")=>U(h(d)).toString(36).slice(1),A=Array.from({length:26},(d,L)=>String.fromCharCode(L+97)),M=d=>A[Math.floor(d()*A.length)],R=({globalObj:d=typeof global<"u"?global:typeof window<"u"?window:{},random:L=Math.random}={})=>{let y=Object.keys(d).toString();return O(y.length?y+k(f,L):k(f,L)).substring(0,f)},B=d=>()=>d++,E=476782367,P=({random:d=Math.random,counter:L=B(Math.floor(d()*E)),length:y=p,fingerprint:w=R({random:d})}={})=>function(){let C=M(d),c=Date.now().toString(36),s=L().toString(36);return`${C+O(`${c+k(y,d)+s+w}`).substring(1,y)}`},H=P(),_=(d,{minLength:L=2,maxLength:y=f}={})=>{let w=d.length,C=/^[0-9a-z]+$/;try{if(typeof d=="string"&&w>=L&&w<=y&&C.test(d))return!0}finally{}return!1};n.exports.getConstants=()=>({defaultLength:p,bigLength:f}),n.exports.init=P,n.exports.createId=H,n.exports.bufToBigInt=U,n.exports.createCounter=B,n.exports.createFingerprint=R,n.exports.isCuid=_})),K=$(((t,n)=>{var{createId:h,init:p,getConstants:f,isCuid:k}=Lt();n.exports.createId=h,n.exports.init=p,n.exports.getConstants=f,n.exports.isCuid=k}));function G(t){return new URL(t,document.baseURI)}function J(t){let n=new URL(window.location.href);t(n.searchParams),window.history.replaceState({},"",n.toString())}function mt(t,n){if(typeof window>"u")return!1;let h=new URLSearchParams(window.location.search);return n===void 0?h.has(t):h.get(t)===n}function bt(){return G(`?file=${`__new__${Q()}`}`).toString()}var Ut=/^(https?:\/\/\S+)$/;function kt(t){return typeof t=="string"&&Ut.test(t)}function St({href:t,queryParams:n,keys:h}){let p=typeof n=="string"?new URLSearchParams(n):n;if(p.size===0||t.startsWith("http://")||t.startsWith("https://"))return t;let f=t.startsWith("#"),k=f&&t.includes("?");if(f&&!k){let _=h?[...p.entries()].filter(([y])=>h.includes(y)):[...p.entries()],d=new URLSearchParams;for(let[y,w]of _)d.set(y,w);let L=d.toString();return L?`/?${L}${t}`:t}let U=t,O="",A=new URLSearchParams,M=f?1:0,R=t.indexOf("#",M);R!==-1&&(O=t.slice(R),U=t.slice(0,R));let B=U.indexOf("?");B!==-1&&(A=new URLSearchParams(U.slice(B+1)),U=U.slice(0,B));let E=new URLSearchParams(A),P=h?[...p.entries()].filter(([_])=>h.includes(_)):[...p.entries()];for(let[_,d]of P)E.set(_,d);let H=E.toString();return H?`${U}?${H}${O}`:t}var vt=(0,K().init)({length:6});function Q(){return`s_${vt()}`}function Y(t){return t?/^s_[\da-z]{6}$/.test(t):!1}var _t=(()=>{let t=new URL(window.location.href).searchParams.get(W.sessionId);return Y(t)?(J(n=>{n.has(W.kiosk)||n.delete(W.sessionId)}),j.debug("Connecting to existing session",{sessionId:t}),t):(j.debug("Starting a new session",{sessionId:t}),Q())})();function Z(){return _t}var xt=class{constructor(t,n=!1){N(this,"initialHealthyCheck",new ft);this.config=t,this.lazy=n;try{new URL(this.config.url)}catch(h){throw Error(`Invalid runtime URL: ${this.config.url}. ${h instanceof Error?h.message:"Unknown error"}`)}this.lazy||this.init()}get httpURL(){return new URL(this.config.url)}get isSameOrigin(){return this.httpURL.origin===window.location.origin}formatHttpURL(t,n,h=!0){t||(t="");let p=this.httpURL,f=new URLSearchParams(window.location.search);if(n)for(let[k,U]of n.entries())p.searchParams.set(k,U);for(let[k,U]of f.entries())h&&!Object.values(W).includes(k)||p.searchParams.set(k,U);return p.pathname=`${p.pathname.replace(/\/$/,"")}/${t.replace(/^\//,"")}`,p.hash="",p}formatWsURL(t,n){return Rt(this.formatHttpURL(t,n,!1).toString())}getWsURL(t){let n=new URL(this.config.url),h=new URLSearchParams(n.search);return new URLSearchParams(window.location.search).forEach((p,f)=>{h.has(f)||h.set(f,p)}),h.set(W.sessionId,t),this.formatWsURL("/ws",h)}getWsSyncURL(t){let n=new URL(this.config.url),h=new URLSearchParams(n.search);return new URLSearchParams(window.location.search).forEach((p,f)=>{h.has(f)||h.set(f,p)}),h.set(W.sessionId,t),this.formatWsURL("/ws_sync",h)}getTerminalWsURL(){return this.formatWsURL("/terminal/ws")}getLSPURL(t){if(t==="copilot"){let n=this.formatWsURL(`/lsp/${t}`);return n.search="",n}return this.formatWsURL(`/lsp/${t}`)}getAiURL(t){return this.formatHttpURL(`/api/ai/${t}`)}healthURL(){return this.formatHttpURL("/health")}async isHealthy(){if(V()||lt())return!0;try{let t=await fetch(this.healthURL().toString());if(t.redirected){let h=t.url.replace(/\/health$/,"");this.config.url=h}let n=t.ok;return n&&this.setDOMBaseUri(this.config.url),n}catch{return!1}}setDOMBaseUri(t){t=t.split("?",1)[0],t.endsWith("/")||(t+="/");let n=document.querySelector("base");n?n.setAttribute("href",t):(n=document.createElement("base"),n.setAttribute("href",t),document.head.append(n))}async init(t){let n=0;for(;!await this.isHealthy();){if(n>=25){j.error("Failed to connect after 25 retries"),this.initialHealthyCheck.reject(Error("Failed to connect after 25 retries"));return}if(!(t!=null&&t.disableRetryDelay)){let h=Math.min(100*1.2**n,2e3);await new Promise(p=>setTimeout(p,h))}n++}this.initialHealthyCheck.resolve()}async waitForHealthy(){return this.initialHealthyCheck.promise}headers(){let t={"Marimo-Session-Id":Z(),"Marimo-Server-Token":this.config.serverToken??"","x-runtime-url":this.httpURL.toString()};return this.config.authToken&&(t.Authorization=`Bearer ${this.config.authToken}`),t}};function Rt(t){if(!t.startsWith("http")){j.warn(`URL must start with http: ${t}`);let n=new URL(t);return n.protocol="ws",n}return new URL(t.replace(/^http/,"ws"))}function Bt(){let t=new URL(document.baseURI);return t.search="",t.hash="",t.toString()}const tt={url:Bt()},rt=z(tt);var nt=z(t=>new xt(t(rt),q()));function Ht(){return ht(nt)}function et(){return ut.get(nt)}function It(t){if(t.startsWith("http"))return new URL(t);let n=et().httpURL.toString();return n.startsWith("blob:")&&(n=n.replace("blob:","")),new URL(t,n)}export{V as _,Ht as a,St as c,bt as d,J as f,q as g,dt as h,rt as i,mt as l,K as m,It as n,Z as o,G as p,et as r,Y as s,tt as t,kt as u};
